#set ($rpContext = $profileRequestContext.getSubcontext('net.shibboleth.idp.profile.context.RelyingPartyContext'))
#set ($username = $authenticationContext.getSubcontext('net.shibboleth.idp.authn.context.UsernamePasswordContext', true).getUsername())
#set ($passwordEnabled = false)
#if (!$passwordPrincipals or $passwordPrincipals.isEmpty() or $authenticationContext.isAcceptable($passwordPrincipals))
  #set ($passwordEnabled = true)
#end
#set ($mobileContext = $authenticationContext.getSubcontext('fi.csc.shibboleth.mobileauth.api.authn.context.MobileContext'))
#set ($convKey = $mobileContext.getConversationKey())
#set ($eventId = $mobileContext.getEventId())
#set ($processState = $mobileContext.getProcessState())
#set ($errorMessage = $mobileContext.getErrorMessage())
##
<!--[if lte IE 7]> <html lang="fi" itemtype="http://schema.org/WebPage" data-text-size="3" class="no-js text-size-3 lte_ie9 lte_ie8 lte7"> <![endif]-->
<!--[if IE 8]> <html lang="fi" itemtype="http://schema.org/WebPage" data-text-size="3" class="no-js text-size-3 lte_ie9 lte_ie8 ie8"> <![endif]-->
<!--[if IE 9]> <html lang="fi" itemtype="http://schema.org/WebPage" data-text-size="3" class="no-js text-size-3 lte_ie9 ie9"> <![endif]-->
<!--[if gt IE 9]><!--><html lang="fi" itemtype="http://schema.org/WebPage" data-text-size="3" class="no-js text-size-3"><!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>#springMessageText("idp.title", "Web Login Service")</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow, noarchive" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store" />
    <link rel="stylesheet" href="https://vagrant.local/idp/stylesheets/style.css">
    <script src="https://vagrant.local/idp/js/vendor/modernizr-2.8.3.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
        <!--[if lt IE 9]>
            <script src="https://vagrant.local/idp/js/vendor/respond.js"></script>
            <![endif]-->
</head>
<body id="identification-service" class="txlive">
<header id="page-header" role="banner">
    <div id="site-options">
        <div class="container">
            <ul class="language-selection">
            </ul>

            <ul class="adjust-font-size" aria-hidden="true">
                <li><button title="Pienennä tekstikokoa" class="decrease-font-size">A-</button></li>
                <li><button title="Suurenna tekstikokoa" class="increase-font-size">A+</button></li>
            </ul>
        </div>
    </div>
    <div id="header-content" class="container">
        <div class="header-row top-row">
            <div class="container">
                <div class="centered">

                    <div class="logo-row">
                        <h1 class="site-logo">
                            Suomi.fi-tunnistaminen
                        </h1>
                    </div>
                </div>

            </div>
        </div>
        <div class="header-row" id="main-menu">
            <div class="container">
                <div class="header-actions">

                </div>

            </div>
        </div>
    </div>
</header>
<main id="main" role="main" name="main">
    <div class="main">
        <div class="container">
            <div class="row">
            </div>

            <p>Matkapuhelimeesi on lähetetty tunnistuspyyntö, jonka tapahtumatunnus on:</p>
                <p class="strong">$eventId</p>
                        <p><br />Jatka tunnistautumista matkapuhelimellasi:<p>
                        <ol class="numbered-list">
                                <li>Kuittaa tunnistuspyyntö painamalla OK-näppäintä.</li>
                                <li>Tarkista, että tapahtumatunnus on sama kuin yllä.</li>
                                <li>Kuittaa tunnistautuminen painamalla OK-näppäintä.</li>
                                <li>Kirjoita varmenteen tunnusluku-PIN. Paina OK-näppäintä.</li>
                                <li>Odota tunnistautumista.</li>
                        </ol>
                <div class="loader">Haetaan sisältöä...</div>

               <div class="col-xs-12 service-top"><br>
                    <a href=$flowExecutionUrl&_eventId=AuthenticationException class="go-back">Peruuta ja palaa tunnistusvälineen valintaan</a><br>
                </div>
                    <div class="row">
                        <h3>Hyvä tietää</h3>
                        <div class="col-xs-12 col-md-8">
                            <div class="text">
                                <p>Puhelinoperaattorisi veloittaa palvelun käytöstä tekemäsi sopimuksen mukaan.</p>
                                <p>Ota yhteyttä puhelinoperaattoriisi jos haluat ottaa mobiilivarmenteen käyttöösi.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer id="page-footer" role=”contentinfo”>
            <div class="container">
                <div class="row">
                    <div id="footer-logo">
                        <img src="https://vagrant.local/idp/img/footer-logo2.svg" alt="Väestörekisterikeskus logo">
                    </div>
                    <p>Kansalaisen tunnistuspalvelusta vastaa <a href="http://vrk.fi/">Väestörekisterikeskus</a></p>
                    <ul class="link-list">
            <li><a target="_blank" href="https://testi.apro.tunnistus.fi/info/tietoapalvelusta/">Tietoa tunnistautumisesta</a></li>
            <li><a target="_blank" href="https://testi.apro.tunnistus.fi/info/tietosuojaseloste/">Henkilötietolain mukainen tietosuojaseloste</a></li>
            <li><a target="_blank" href="https://testi.apro.tunnistus.fi/info/palaute/">Ilmoita virheestä tai anna palautetta</a></li>
                    </ul>
                </div>
            </div>
        </footer>
        <script src="https://vagrant.local/idp/js/vendor/jquery-1.11.2.min.js"></script>
        <script src="https://vagrant.local/idp/js/plugins.js"></script>
        <script src="https://vagrant.local/idp/js/main.js"></script>

        #if ($processState and !$errorMessage)
        #set ($link = $flowExecutionUrl + "&_eventId=retry")

        <script>
         function rec_ajax(status_url) {
        console.log("Calling rec");
        var jsonMimeType = "application/json;charset=UTF-8";

        $.ajax({
                type:"GET",
                async:"false",
                url: status_url,
                beforeSend: function(x) {
                  if(x && x.overrideMimeType) {
                  x.overrideMimeType(jsonMimeType);
                  }
                },
                dataType:"json",
                success: function(data)
                {
                    console.log(data);

                    var n = data.status.link.indexOf("SSO");
                    console.log("LINK: " + data.status.link);
                    urli = data.status.link.substring(n);
                    console.log("URL: " + urli);
                    if(data.status.state !== "IN_PROCESS") location.href = urli;

                    setTimeout(function(){
                      rec_ajax(urli);
                    }, 3000);

                },
                error: function (request, status, error) {
                alert(request.responseText);
                }
            });
         }

        $(document).ready(rec_ajax("$link"));

        </script>
        #end
    </body>
</html>